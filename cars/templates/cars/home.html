{% extends 'cars/base.html' %}
{% load static %}
{% block title %}Home â€” EMMDAVE AUTOS{% endblock %}

{% block content %}
<!-- Background Video (Mobile Optimized) -->
<link rel="stylesheet" href="{% static 'cars/css/home-bg.css' %}">
<div id="bg-media">
  <video id="bg-video" autoplay muted loop playsinline webkit-playsinline preload="auto" poster="{{ MEDIA_URL }}cars/redr.webp" data-media-url="{{ MEDIA_URL }}cars/">
    <!-- Preferred optimized MP4 for faststart and mobile -->
    <source src="{{ MEDIA_URL }}cars/carv-720.mp4" type="video/mp4">
    <!-- WebM optimized variant if the browser prefers it -->
    <source src="{{ MEDIA_URL }}cars/carv-720.webm" type="video/webm">
    <!-- Fallback to original uploaded MP4 -->
    <source src="{{ MEDIA_URL }}cars/carv.mp4" type="video/mp4">
    <img src="{{ MEDIA_URL }}cars/redr.webp" alt="EMMDAVE AUTOS">
  </video>
  <!-- overlay for user tap-to-play when autoplay is blocked -->
  <div id="bg-tap-overlay" class="bg-tap-overlay" role="button" aria-hidden="true" tabindex="-1">
    <span class="bg-tap-text">Tap to play background video</span>
  </div>
</div>

<!-- Hero Section with Customer Counter -->
<div class="container text-center text-light py-5" style="position:relative; z-index:1;">
  <div class="round-text animate__animated animate__fadeIn">EMMDAVE AUTOS</div>
  <h1 class="display-4 fw-bold text-warning animate__animated animate__bounceInDown mt-4">ðŸš— Welcome!</h1>
  <p class="lead">
    Over <span id="heroCounter">1500</span> Happy Customers
  </p>
</div>

<!-- About Section -->
<section id="about" class="container bg-dark bg-opacity-50 rounded-4 p-4 mt-5" style="position:relative; z-index:1;">
  <h2 class="text-warning">Why Choose Us</h2>
  <p>
    We are a trusted car dealership in Lagos, Nigeria. 
    EMMDAVE AUTOS has delivered over <strong>{{ customers|default:1500 }}</strong> cars across Nigeria 
    with unmatched customer satisfaction.
  </p>
</section>

<!-- Image marquee (infinite left-to-right) -->
<div id="solver" class="solv" aria-label="Partner logos marquee" tabindex="0">
  <div class="solver-wrap">
    <div class="solver-track" role="list">
      <img src="{{ MEDIA_URL }}cars/fer1.png" alt="fer1" loading="lazy">
      <img src="{{ MEDIA_URL }}cars/fer2.png" alt="fer2" loading="lazy">
      <img src="{{ MEDIA_URL }}cars/fer3.png" alt="fer3" loading="lazy">
    </div>
  </div>
</div>

  <div class="solver-controls" aria-hidden="false">
    <button id="solver-toggle" class="solver-control" type="button" aria-pressed="false" aria-label="Pause marquee">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M6 4h4v16H6zM14 4h4v16h-4z" fill="#fff"/>
      </svg>
      <span class="visually-hidden">Pause marquee</span>
    </button>
    <div id="solver-announcer" class="visually-hidden" aria-live="polite"></div>
  </div>

  <script>
  // Enhanced marquee controls: click image or control to toggle pause/play; update ARIA
  (function(){
    var solver = document.getElementById('solver');
    if(!solver) return;
    var track = solver.querySelector('.solver-track');
    var btn = document.getElementById('solver-toggle');
    var ann = document.getElementById('solver-announcer');

    var setPaused = function(p){
      if(p){
        track.classList.add('paused');
        if(btn) { btn.setAttribute('aria-pressed','true'); btn.setAttribute('aria-label','Play marquee'); }
        if(ann) ann.textContent = 'Marquee paused';
      } else {
        track.classList.remove('paused');
        if(btn) { btn.setAttribute('aria-pressed','false'); btn.setAttribute('aria-label','Pause marquee'); }
        if(ann) ann.textContent = 'Marquee playing';
      }
    };

    var togglePause = function(){ setPaused(!track.classList.contains('paused')); };

  // Control button only (clicking images no longer toggles)
  if(btn) btn.addEventListener('click', function(e){ e.stopPropagation(); togglePause(); });
    // Keyboard
    solver.addEventListener('keydown', function(e){ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); togglePause(); } });

    // initialize announcer
    if(ann) ann.textContent = track.classList.contains('paused') ? 'Marquee paused' : 'Marquee playing';
  })();
  </script>

  <script>
  // JS-driven ticker for smooth left-to-right motion (car-like)
  (function(){
    var solver = document.getElementById('solver');
    if(!solver) return;
    var track = solver.querySelector('.solver-track');
  var speed = 60; // pixels per second (higher = faster)
  var paused = track.classList.contains('paused');

    // Continuous leftward loop with seamless wrap. We duplicate the track items
    // in JS (if not already duplicated) so we can scroll the first set off-screen
    // and immediately continue with the cloned set.
    function computeSingleWidth(){
      var children = Array.prototype.slice.call(track.children);
      // assume original set is the first N children; if we stored originalCount use it
      var orig = parseInt(track.dataset.origCount || children.length, 10);
      orig = Math.max(1, Math.min(orig, children.length));
      var w = 0;
      for(var i=0;i<orig;i++){
        w += children[i].getBoundingClientRect().width;
      }
      var gap = parseFloat(getComputedStyle(track).gap || 10);
      w += gap * Math.max(0, orig - 1);
      return w;
    }

    function ensureDuplicate(){
      var children = Array.prototype.slice.call(track.children);
      if(!track.dataset.origCount){ track.dataset.origCount = children.length; }
      var orig = parseInt(track.dataset.origCount, 10);
      // if we already have at least 2*orig items, assume duplicated
      if(children.length >= orig * 2) return;
      // clone the original items
      for(var i=0;i<orig;i++){
        var clone = children[i].cloneNode(true);
        track.appendChild(clone);
      }
    }

    var pos = 0;
    var singleWidth = 0;
    var lastTs = null;

    function frame(ts){
      if(!lastTs) lastTs = ts;
      var dt = (ts - lastTs)/1000; lastTs = ts;
      if(!paused){
        pos -= speed * dt; // move left continuously
        if(singleWidth && Math.abs(pos) >= singleWidth){
          pos += singleWidth; // wrap
        }
        track.style.transform = 'translateX(' + pos + 'px)';
      }
      requestAnimationFrame(frame);
    }

    var observer = new MutationObserver(function(){ paused = track.classList.contains('paused'); });
    observer.observe(track, { attributes:true, attributeFilter:['class'] });

    function kickOff(){
      // ensure cloned set exists and compute single set width for wrapping
      ensureDuplicate();
      singleWidth = computeSingleWidth() || 0;
      pos = 0;
      lastTs = null;
      requestAnimationFrame(frame);
    }

    window.addEventListener('load', kickOff);
    window.addEventListener('resize', function(){
      ensureDuplicate();
      singleWidth = computeSingleWidth();
    });
  })();
  </script>

<!-- Cars Section -->
<section id="cars" class="container mt-5" style="position:relative; z-index:1;">
  <h2 class="text-warning text-center">Available Cars</h2>
  <div class="row mt-4">
    {% for car in cars %}
    <div class="col-md-3 mb-4">
      <div class="card bg-dark text-light border-0 shadow-lg">
        {% if car.images.first %}
          <img src="{{ car.images.first.image.url }}" class="card-img-top" style="height:180px;object-fit:cover;" alt="{{ car.title }}">
        {% else %}
          <img src="https://via.placeholder.com/300x180?text=No+Image" class="card-img-top" alt="No image available">
        {% endif %}
        <div class="card-body">
          <h5 class="card-title text-warning">{{ car.title }}</h5>
          <p class="card-text">{{ car.description|truncatewords:10 }}</p>
          <a href="{% url 'cars:detail' car.slug %}" class="btn btn-warning btn-sm w-100">View Details</a>
        </div>
      </div>
    </div>
    {% empty %}
    <p class="text-light text-center">No cars available at the moment.</p>
    {% endfor %}
  </div>
</section>

<!-- Customer Counter Section -->
<section id="counter-section" class="text-center mt-5" style="position:relative; z-index:1;">
  <h2 class="text-warning">Customer Counter</h2>
  <h3 id="sectionCounter" class="fw-bold display-5 text-success mt-2">1500</h3>
</section>

<!-- Google Map -->
<section id="map" class="container mt-5" style="position:relative; z-index:1;">
  <h2 class="text-warning text-center">Our Location</h2>
  <iframe class="rounded-4 mt-3 w-100" height="350"
    src="https://www.google.com/maps?q=Alimosho,+Lagos,+Nigeria&output=embed"
    title="EMMDAVE AUTOS location map" loading="lazy" allowfullscreen></iframe>
</section>

<!-- WhatsApp Button -->
<a href="https://wa.me/2348012345678" target="_blank" style="position:fixed;bottom:20px;right:20px; z-index:2;">
  <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" width="60" alt="WhatsApp">
</a>

<!-- Infinite Customer Counter Script -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const heroCounter = document.getElementById("heroCounter");
  const sectionCounter = document.getElementById("sectionCounter");

  let heroValue = parseInt(heroCounter.innerText) || 1500;
  let sectionValue = parseInt(sectionCounter.innerText) || 1500;

  function countUp() {
    heroValue += Math.floor(Math.random() * 10) + 1;
    sectionValue += Math.floor(Math.random() * 10) + 1;

    heroCounter.innerText = heroValue.toLocaleString();
    sectionCounter.innerText = sectionValue.toLocaleString();

    requestAnimationFrame(countUp);
  }

  countUp();
});
</script>

<!-- Spinning Text CSS -->
<!-- Play button and background behavior are provided by external static files -->
<button id="bg-play-button" type="button" title="Play background video" aria-label="Play background video">
  <svg width="48" height="48" viewBox="0 0 24 24" fill="#fff" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
    <path d="M8 5v14l11-7z"/>
  </svg>
  <span class="visually-hidden">Play background video</span>
</button>

<script src="{% static 'cars/js/home-bg.js' %}"></script>
{% endblock %}
